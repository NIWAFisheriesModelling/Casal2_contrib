---
title: "ExampleUseage"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ExampleUseage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
number_sections: false  
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, echo=T, results='hide'}
library(Casal2, warn.conflicts = F)
library(r4Casal2, warn.conflicts = F)
library(tidyverse)
library(ggplot2)

```

### Introduction
to see these vignettes type in `browseVignettes("stockassessmenthelper")` or `vignette("ExampleUseage")` or compile it yourself with knitr. Also hopefully all functions are documented so to query the inputs to a function use the `?` i.e. `?sim_pars`

## Selectivities
```{r selectivities, fig.width=8, fig.height=6}
ages = 1:40
# logistic
sel_data_frame = data.frame(ages = ages, constant = constant_sel(0.8, ages), 
           "knife edge" = knife_sel(6, ages), 
           logistic = logis_sel(ages, 6, 5), 
           "inverse logistic" = inv_logis_sel(ages, 6, 5), 
           "double normal" = d_norm_sel(ages, 6, 2, 15), 
           "double exponential" = d_exp_sel(bins = ages, x_1 = 1, x_2 = 30, x_0 = 6, y_1 = 0.25, y_2 = 0.15, y_0 = 0.09))
sel_lng = melt(sel_data_frame, id.vars = "ages")
ggplot(sel_lng, aes(x = ages, y = value, group = variable, col = variable)) +
  geom_line(size = 2) +
  facet_wrap(~variable)

```


## Surplus Production models


## Growth
visualising growth functions and distributions of mean length at age. There are two growth functions available Von Bertalanffy `vonbert` and the generalised schnute growth function `schnute`.

```{r plot_Growth, fig.width=5, fig.height=4}
col_legend = c("obs" = "#999999", "true" = "#E69F00",  "estimated" = "#56B4E9")
L_inf = 53
k = 0.17
t0 = -1.2
cv1 = 0.1
cv2 = 0.15
ages = 1:40
length_at_age = vonbert(ages, K = k, L_inf = L_inf, t0 = t0)
# cvs are by length
cvs_length = cv_by_length(cv1, cv2, length_at_age)
cvs_by_age = stretch(cv1, cv2, min(ages), max(ages))
growth_plot = ggplot(data = data.frame(age = ages, length = length_at_age), aes(x = age, y = length)) +
         geom_line(aes( col = "true"), size = 2) +
  scale_color_manual(values = col_legend)
growth_plot
```

```{r cv_for_growth, fig.width=5, fig.height=4}
## view the cv's
plot(ages, cvs_length, ylab = "CV for mean length at age", xlab = "Age", type = "o", lwd = 3, ylim = c(0.05, 0.2))
lines(ages, cvs_by_age, lwd = 3, lty = 2, col = "red")
legend('bottomright', col = c("black","red"), lwd = 3, legend = c("By length", "By Age"))
```

randomly generate synthetic data

```{r generate_growth_data, fig.width=5, fig.height=4}
n_samples_per_age = 5
age_length_data = NULL
for(a in 1:length(ages)) {
  lengths = r_lnorm(n_samples_per_age, length_at_age[a], cv = cvs_length[a])
  age_length_data = rbind(age_length_data, data.frame(age = a, length = lengths))
}
growth_plot_w_obs = growth_plot +
  geom_point(data = age_length_data, aes(col = "obs"), alpha = 0.7)
growth_plot_w_obs
```

```{r est_Growth, fig.width=5, fig.height=4}
library(FSA) # a useful function for estimating growth
vbT <- vbFuns("typical")  ## set growth model type
# ?vbFuns for more growth curves. Not sure what error distribution this assumes?
start_ <- vbStarts(length~age,data = age_length_data,type="typical")  # start values
fit_ <- nls(length ~ vbT(age,Linf,K,t0),data = age_length_data, start = start_) # optimisation
pars_ = fit_$m$getPars() # get pars
pars_
fitted_line = vonbert(ages, K = pars_["K"], L_inf = pars_["Linf"], t0 = pars_["t0"])
growth_plot_w_obs +
  geom_line(data = data.frame(age = ages, length = fitted_line), aes(col = "estimated"), linetype = "dashed", size = 2)
```


Another plot of length at age


```{r alt_growth_plot, fig.width=5, fig.height=4, eval=FALSE}
## concentrate on 3 ages for clarity
std_devs = log_sigma(cvs_length)
draws = 2000
ages_ndx = c(11:13)
these_ages = ages[ages_ndx]
dat = c(rnorm(draws, length_at_age[ages_ndx[1]], std_devs[ages_ndx[1]]),rnorm(draws, length_at_age[ages_ndx[2]], std_devs[ages_ndx[2]]),rnorm(draws, length_at_age[ages_ndx[3]], std_devs[ages_ndx[3]]))
dat = cbind(dat, c(rep(length_at_age[ages_ndx[1]], draws),rep(length_at_age[ages_ndx[2]], draws),rep(length_at_age[ages_ndx[3]], draws)))
dat = cbind(dat, c(runif(draws,these_ages[1] - 1,these_ages[1]), runif(draws,these_ages[1],these_ages[2]), runif(draws,these_ages[2],these_ages[3])))
cuts = cut(these_ages, breaks =c(min(these_ages)-1,these_ages))
dat = as.data.frame(dat)
dat$breaks = sort(rep(cuts, draws))
dat$age = sort(rep(these_ages, draws))
colnames(dat) = c("lengths","mean_length", "ages","breaks","age")

dens <- do.call(rbind, lapply(split(dat, dat$breaks), function(x) {
    xs <- seq(min(x$lengths) - 1, max(x$lengths) + 1, len=draws)
    norm = dnorm(xs, x$mean_length, 2)
    norm = x$age - norm /  (max(norm) + quantile(norm,0.5))
    res <- data.frame(y=xs, x=norm)
}))
dens$breaks = dat$breaks
ggplot(dat, aes(x = age, y = mean_length)) +
  xlim(min(these_ages) - 1, max(these_ages)) + 
  geom_polygon(data=dens, aes(x, y, group = breaks),fill = "lightblue" ,alpha = 0.9) +
  geom_point(col = "black") + 
  labs(x = "Age",y = "Length (cm)") + 
  theme_bw()+
  theme(axis.text.x=element_text(size=15),axis.text.y=element_text(size=15),
        axis.title=element_text(size=15,face="bold"))
```



## CASAL helpers
### Profiling Parameters
Assuming you have done a casal profile `casal -p` run the function `plot_CASAL_profile` will create a ggplot showing the effects of each objective contribution.

```{r profile_comps}
# see what objective function components can be visualised?
data_path = system.file("extdata", package = "stockassessmenthelper")
possible_components = plot_CASAL_profile(file = "2021_profile_R0.casal", path = data_path, 
                 profiled_param = "initialization.R0", objective_function_components = "all", 
                 element = NULL, ask_for_obj_labels = T, likelihood_cut_off = 100, 
                 custom_xlim = c(0,2e7))
possible_components
```



```{r profile_plot, fig.height = 7, fig.width = 4, fig.align = "center"}

# create a plot for a subset of these.
R0_profile = plot_CASAL_profile(file = "2021_profile_R0.casal", path = data_path, 
                 profiled_param = "initialization.R0", 
                 objective_function_components = c("BP_SPUE","REC_CPUE" ,"PS_AGE" ,"REC_AGE", "ST_AGE"), 
                 element = NULL, ask_for_obj_labels = F, likelihood_cut_off = 100, 
                 custom_xlim = c(0,2e7))
```

Another useful function for summarising a profiled run is the `extract.multiple.quantities`


### Simulating different starting values (Jittering)
To test the robustness of your assessment to the choice of starting values.

```{r start_values}
diff_start_vals = sim_pars(dash_o_file_name = "MPD_dash_o_file.out", csl_path = data_path,
                 plus_minus_for_bounds = 0.1, n_pars = 10, index_of_pars_fixed = NULL)
diff_start_vals[1:5,1:5]
```

this function will create a file called `sim_pars` in the `csl_path`, which can be used in the `-i` format for a CASAL model run.



### Pulling out states from a CASAL run
The following functions will pull out numbers at age from a CASAL model.
`extract.step.AFs` and `extract.state` 


### ReWeighting
An automated function for running Chris Francis's reweighting Method TA1.8 approach on a CASAL model. Please read the details on this function it will **overwrite** the csl file. So it is adviced to save a copy of the original before running this code. Look at the function `?run_reweight`


